---
title: "Bible"
output:
  html_document:
    css: ../../../../styles.css
    df_print: paged
    number_sections: yes
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center')
```


# Reading in data 

Almost all data you work with in R will be read in from an external file. Knowing how to get data from external files gives you access to a whole world of data. In this lesson you'll be learning about a special type of external file called a *flat text file*. Underlying these files are just plain text. This means you can open all these files in a text editor and "read" the data yourself.

Each different form of flat text file will have a different way of specifying the rows and columns in the data. To read this data into R you'll need to understand how these are specified and tell R how to read the data in.

# CSV files

*Set up a new project for this lesson and copy over the data folder from the class notes into the same location as your new R project (i.e. where the .RProj file is).*

Let's load `tidyverse` again, which will give us access to the `readr` package and let us read files.

```{r, results='hide', warning = FALSE, message = FALSE}
library(tidyverse)
```

Comma Separated Variable files (CSVs) are the most common form of text data. If you open up the data in a text editor, you will be able to see that each variable is separated by a comma and each new observation goes on a new row. This form of data is easy for lots of different programs (including Excel) to use so makes it a very good choice when you need to store data. 

To read in a CSV file we will use the function `read_csv`. Since you should be inside a project, you only need to specify the location of the file *in relation to your current directory*.

First we are going the read the file called `dog_bites.csv`. 

*First open it in a text editor to see how it looks in its raw format.*

Then, read the data into R.

```{r}
read_csv("data/dog_bites.csv")
```

Note that the output tells us a bit about our data. First we can see that this is a "tibble" with 8,707 rows and 6 columns. A "tibble" is the Tidyverse name for rectangular data: data that comes in rows and columns, where every column is the same length.

Underneath each column name we can see the type of the column. These correspond to the types of vector that we discussed yesterday. That's because a tibble is made up of vectors!

If we want to do something with the data we need to assign a name to it using `<-`. You can read this bit of code as "assign the name `dog_bites` to the data generated by this code".

```{r}
dog_bites <- read_csv("data/dog_bites.csv")
```

Remember that the 'Files' window in the bottom right in RStudio will show you all the files you have in your project's folder. 

**Note:** there is a difference between `read_csv()` and `read.csv()`. The first is the tidyverse version of the function, and the second is the base R version. We want to always be using the `read_csv()` when working with tidyverse.

# Excel Files

Excel is enormously popular, and you are sure to come across data that you want to read which is stored as an Excel spreadsheet. In general it's best to read files in the format they originally come from. However it you are having problems reading in a small number of Excel files, it might be easier to save them as CSV files before reading them in. (Go to File > Save As, in Excel). Note that this will get rid of formatting, functions and extra tabs in Excel so be careful!

## The `readxl` package

To read Excel files we use the `readxl` package. Install and load this package as normal.

```{r, eval = FALSE}
install.packages("readxl")
```

```{r}
library(readxl)
```

We read the file using the `read_excel` function. Note that the package is called `readxl` and the function is `read_excel`.

Open up the file `edinburgh_seedmix.xlsx`. This has data on which flowers are planted in wild flower meadows throughout Edinburgh. The data is across several sheets. If we use `read_excel` it will only read in the first sheet:

```{r}
seedmix <- read_excel("data/edinburgh_seedmix.xlsx")
seedmix
```

You can specify which sheet you want to read in two ways. Either by the position of the sheet, where 1 is the first sheet, 2 is the second etc.

```{r}
seedmix_north <- read_excel("data/edinburgh_seedmix.xlsx", sheet = 3)
```
```{r}
seedmix_north
```

Or by using the name of the sheet. 

```{r}
seedmix_north <- read_excel("data/edinburgh_seedmix.xlsx", sheet = "North Neighbourhood")
```
```{r}
seedmix_north
```

Sheets can move position easily, so it's slightly safer to use the name of the sheet. Of course sheets can change name easily too! However, if a sheet name doesn't exist and you try to read it in by name you'll get an error. While if a sheet has moved position, you won't get an error, but you will have the wrong data. 

You can list all the sheets in an Excel file using `excel_sheets`.

If you have formulas in your spreadsheet, `readxl` will read in the value only. Hopefully any formatting in your spreadsheets do not affect the meaning of the sheet, since formatting cannot be read into R.

<blockquote class = 'task'>

**Task - 5 minutes**

Read in the "South Neighbourhood" data from our seedmix data, by

1. Position
2. Sheet name

<details>
<summary>**Solution**</summary>

```{r}
# Solution 1
seedmix_south <- read_excel("data/edinburgh_seedmix.xlsx", sheet = 4)
```

```{r}
# Solution 2
seedmix_south <- read_excel("data/edinburgh_seedmix.xlsx", sheet = "South Neighbourhood")
```

</details>
</blockquote>


# Writing files

To create a CSV file you need to use the function `write_csv`. 

Let's try writing a dataset from the CodeClan data package to a file. Load `CodeClanData` and have a look at the data frame `students`.

```{r, message = F}
library(CodeClanData)

students
```

Now we can write this to a file called `students.csv`.

```{r, eval=FALSE}
write_csv(students, "students.csv")
```

You can also write to folders, relative to your project folder. If you are going to write to a folder, make sure you create the folder first.

```{r, eval=FALSE}
write_csv(students, "clean_data/students.csv")
```

You can also write Excel files, however to do this you'll need a different package. `openxlsx` is one option.


# Reading other file types - Optional

CSV and XLSX are not the only types of file you will encounter. We will now briefly cover a few other common types of files and how to read them.

For each file I recommend trying to open them in a text editor and in a spreadsheet viewer before reading them into R. This will give you an idea of what each file type looks like in its raw form.

If you come across a file you can't work out how to open the best thing to do is to Google 'how to open [file type] in R'. Although, sometimes the file extension will be unhelpful in deciding how to read data in. Having some familiarity of how different file types look in their raw form will help you open unfamiliar files in the future.


## Tab separated variables 

Tab separated variables are a reasonably common form of data. Often known as TSVs, we use a very similar function as the one for CSVs:

```{r}
bands <- read_tsv("data/indie_bands.txt")
```

```{r}
bands
```

## Delimited files

CSVs and TSVs are both subtypes of a more general form of data known as 'delimited files'. These are files where each variable is separated using a special character (commas for CSVs and tabs for TSVs) and each observation is on a new line. Almost any character can be used to separate variables, in the file below semi-colons were used. 

```{r}
beer <- read_delim("data/beer.txt", delim = ";")
```

```{r}
beer
```

Delimited files look easy to write by hand but I'd strongly recommend against doing this. Use the writing functions in R (`write_csv`, `write_tsv` and `write_delim`) or use a spreadsheet program like Excel to manually input data, and save as a delimited file. If you have a choice use CSV as this is the most common delimited file type by far. 

## Fixed width files

Not all files are delimited. The temperature data below looks like it might be separated by tabs, but not quite. Each variable in the data is lined up so that the same variable starts the same number of columns across. Often these can be opened easily using `read_table` as long as there is white space between each column. 

```{r }
max_temp <- read_table("data/maxtemp.txt")
```

```{r}
max_temp
```

However, occasionally you will find data lined up in columns without space between each column. To open this you will need to use `read_fwf` (read fixed-width-file) and manually specify the size of each of the columns. If you do ever need to do this, give the help page for `read_fwf` a read. 

We can perform the opposite of reading files - writing files - just by using the functions: `write_tsv` and `write_delim`. Note there is no `write_table` or `write_fwf` - it's pretty unusual to need to write these types of file.

# URL paths - Optional

All the data we've seen so far has been stored locally, but `readr` can read in datasets over the internet. Rather than give the relative path from your project, just give the URL the data is located at.

<blockquote class = 'task'>

**Task - 10 minutes**

Go to https://www.cpc.ncep.noaa.gov/data/indices/wksst8110.for to see the dataset we are going to read in.

Read this in directly from the URL.

<details>
<summary>**Solution**</summary>

```{r}
wksst <- read_table("https://www.cpc.ncep.noaa.gov/data/indices/wksst8110.for",
  skip = 4,
  col_names = c(
    "week",
    "Nino12",
    "Nino3",
    "Nino34",
    "Nino4"
  )
)
```

```{r}
wksst
```

</details>
</blockquote>


# Reading in multiple sheets - Optional

A lot of Excel sheets you will encounter will contain more than one sheet. Here is some bonus code that reads in all the different sheets in the file `edinburgh_seedmix.xlsx`. 

Note: this goes beyond the scope of this course, but it's useful code to have. You will need to read up on loops in R, or functional programming packages such as `purrr` to understand these. 


```{r, eval = FALSE}
library(readxl)

## Method 1 (no loops) - lappy & naming the sheets the names of the tabs.
name_sheets<-excel_sheets("data/edinburgh_seedmix.xlsx")
num_sheets<-length(name_sheets)

all_tabs <- lapply(name_sheets, function(x) read_excel("data/edinburgh_seedmix.xlsx", sheet = x))
names(all_tabs)<-name_sheets
#list2env(all_tabs, globalenv()) #may not be necessary to do this step - may want to just call each element of the list

## Method 2  - start with a list and loop through assigning elements of the list
all_tabs <- list()
name_sheets<-excel_sheets("data/edinburgh_seedmix.xlsx")

for(sheet in name_sheets) {
  all_tabs[[sheet]] <- data.frame(read_excel("data/edinburgh_seedmix.xlsx", 
                                                    sheet = sheet))
}


## Method 3 - loops & naming the sheets 'data_sheet_1' etc.
num_sheets<-length(excel_sheets("data/edinburgh_seedmix.xlsx"))

for(i in 1:num_sheets) {
  assign(paste0("data_sheet_",i), data.frame(read_excel("data/edinburgh_seedmix.xlsx", 
                                                sheet = i)))
}

## Method 4 - loops & naming the sheets the names of the tabs.
name_sheets<-excel_sheets("data/edinburgh_seedmix.xlsx")
num_sheets<-length(name_sheets)

for(i in 1:num_sheets) {
  assign(name_sheets[i], data.frame(read_excel("data/edinburgh_seedmix.xlsx", 
                                                        sheet = i)))
  }
```

